

# vagga configuration for a cross rust dev environment
# The container will compile rust for a target other than the container's host.
# E.g. target is embedded computer having such as ARM ISA

# Using a chain of containers.
# Checkpoints containers so they don't rebuild when one fails to install
# Each more  specific than its parent
# In the order of likelihood to fail (most stable containers first.)


containers:

  # basic container having C language tools
  
  base:
  
    setup:
    - !Ubuntu xenial
    
    # !!! Add repositories/ppa's for some "interesting" packages such as gcc-arm-none-eabi
    # - !UbuntuUniverse

    # C compiler and other tools
    # overkill? but still doesn't install curl?
    - !Install [build-essential, ca-certificates]

    # Subsequent containers (rustup) need curl
    - !Install [curl]
    
    # Subsequent containers optionally use git
    - !Install [git]



  
  
  # container having rustup
  # rustup is toolchain mulitplexer (nightly and other versions of rust tools).
  # cargo will not install rustup; rustup installs cargo.
  
  # An alternative is to install a single version of rust from a binary distribution.
  
  # Rustup installation installs not only rustup, but a (first) version of rust tools.
  # Default to version: nightly (i.e. unstable).
  
  # We choose nightly because cross compiling requires it (as of this writing.)
  
  rustup:
  
    environ:
      PATH: "/work/.home/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      HOME: /work/.home
      RUSTUP_HOME: /work/.home/.cargo
      
    setup:
    
    # depends on previous container
    - !Container base
    
    # rustup.sh is deprecated, use rustup.rs which downloads and runs rustup-init
    
    # Configure rustup-init with env vars in environ of build
    # Unless these are set in build env, installs to /tmp/.rustup and it goes away
    - !Env
      RUST_TARGET_PATH: /work/.home
      RUSTUP_HOME: /work/.home/.cargo
      CARGO_HOME: /work/.home/.cargo
      
    - !Download
      url: https://sh.rustup.rs
      path: /work/rustup.rs
      mode: 0o744
      
    - !Sh "/work/rustup.rs -y --default-toolchain nightly"
    
 
  # Cross compiling using xargo requires rust src
  
  rustupWSource:
    environ:
      PATH: "/work/.home/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      CARGO_HOME: /work/.home/.cargo
      
    setup:
    - !Container rustup
    
    - !Env
      PATH: "/work/.home/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      RUST_TARGET_PATH: /work/.home
      
    - !Sh "rustup component add rust-src"
  
  
  
  
  # container having cargo's clone subcommand
  
  rustupWSourceAndClone:
    setup:
      # depends on previous container
      - !Container rustupWSource
  
      # cargo-clone requires pkg-config to find OpenSSL library
      - !Install [pkg-config]
      
      # cargo-clone build uses cmake
      - !Install [cmake]
      
      # cargo-clone requires openssl library
      - !Install [libssl-dev]
      
      # clone subcommand is not installed in default  Rust installation
      - !Sh "cargo install cargo-clone --force"
      
      # mv from build dir /tmp
      # - !Sh "mv /tmp/.cargo/bin/cargo-clone /usr/bin"
  
      

  # container for cross compiling Rust to any target
  # i.e. having xargo
  
  rustCrossDev:
  
    environ:
      PATH: "/work/.home/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      # /work/target/.cargo
      CARGO_HOME: /work/.home/.cargo
      
    setup:
    - !Container rustupWSourceAndClone
    
    # env of build
    - !Env
      PATH: "/work/.home/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      RUST_TARGET_PATH: /work/.home
    
    - !Sh "which xargo"
    
    # install Xargo (cross compiling helper) from crate.io
    # --force overwrites previous installation
    # - !Sh "cargo install xargo --force"
    
    
    
    # clone, patch, build, install xargo
    - !Sh rm -rf /work/xargo
    - !Sh "git clone https://github.com/japaric/xargo.git"
    - !EnsureDir /work/xargo
    
    # patch.  Hacky, not very specific
    - !Sh "sed -i 's/0.1.7/0.2.0/g' /work/xargo/Cargo.toml"
    #- !Sh "sed -i 's/meta.channel/meta.unwrap().channel/g' /work/xargo/src/main.rs"
    #- !Sh "sed -i 's/meta.host/meta.unwrap().host/g' /work/xargo/src/main.rs"
    - !Sh "sed -i 's/rustc::version()/rustc::version().unwrap()/g' /work/xargo/src/main.rs"
    
    - !Sh |
        cd /work/xargo
        cargo install --force
    
    
    # it installed to /tmp/...  , which goes away, so move it to where cargo binary is installed
    #- !Sh "mv /tmp/.cargo/bin/xargo /usr/bin"
    
    
  
  
  rustTestVersion:
  
    environ:
      PATH: "/work/.home/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      # /work/target/.cargo
      CARGO_HOME: /work/.home/.cargo
      
    setup:
    - !Container rustupWSourceAndClone
    
    # env of build
    - !Env
      PATH: "/work/.home/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      RUST_TARGET_PATH: /work/.home
   
    
    # clone,  build, test
    - !Sh rm -rf /work/rustc-version-rs
    - !Sh "git clone https://github.com/Kimundi/rustc-version-rs.git"
    - !EnsureDir /work/rustc-version-rs
   
    
    - !Sh |
        cd /work/rustc-version-rs
        cargo build
        cargo test
    
    

    
  
  
  # container for cross compiling Rust to a specific target family: ARM Cortex M family
  # E.g. having demo source
  # E.g. where demo source has a board package for ARM?
  
  rustCortexM:
    environ:
      PATH: "/work/.home/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      CARGO_HOME: /work/.home/.cargo
      RUST_BACKTRACE: 1
      
    setup:
    # depends on previous container
    - !Container rustCrossDev
    
    # cargo seems to want to put .cargo_lock in read only /root?
    # so redirect home directory of user root to a writeable directory
    - !Sh "sed -i '/^root/{s@/root@/work/.home@;}' /etc/passwd"
    
    # remove previously installed stuff
    # !!! This deletes any hacks you made
    # -f no prompts, and ignore if not exist
    - !Sh "rm -Rf cortex-m-quickstart"
    - !Sh "rm -Rf demo"
    
    # fetch source of crate 
    # from official rust repository crates.io
    # to /work
    - !Sh "cargo clone cortex-m-quickstart --vers 0.1.1"
    
    # rename so we can hack
    - !Sh "mv cortex-m-quickstart demo"
    
    # TODO futz with Cargo.toml metadata to reflect new author
    - !Sh "sed -i 's/cortex-m-quickstart/demo/g' demo/Cargo.toml"
    
    # xargo wants source
    # - !Sh "rustup component add rust-src"
  
  # cargo seems to want to put .cargo_lock in /root?
    #volumes:
       #/root: !BindRW /work/tmp
   
    



  

commands:


  # Conventional commands
  # Purpose should be to run and test ultimate project artifact, an application
  
  test: !Command
    description: Test build hello for Cortex M
    container: rustCortexM
    run: |
      cd demo
      xargo build --example hello
  
  
  run: !Command
    description: Build blinky, burn to target, and run remote debugger
    container: rustCortexM
    run: |
      which xargo
      xargo build --target thumbv6m-none-eabi -v
      # thumbv6m-none-eabi
      # thumbv7m-none-eabi
      # x86_64-unknown-linux-gnu
      
      
  # Commands to test container sanity
  
  testCargo: !Command
    description: Test cargo is installed in container rustNightlyDev
    container: rustNightlyDev
    run: |
      which cargo
      cargo --version
  
  testCargoInRustup: !Command
    description: Test cargo is installed in container rustup
    container: rustup
    run: |
      which cargo
      cargo --version
      
  testRustup: !Command
    description: Test rustup is installed in container rustup
    container: rustup
    run: |
      which rustup
      rustup --version
      
  testRustc: !Command
    description: Test rustc is installed in container rustup
    container: rustup
    run: |
      env
      which rustc
      rustc -vV
    
  testVersion: !Command
    description: Test rustc-version
    container: rustTestVersion
    run: |
      env
      which rustc
      rustc -vV
    
    
  testXargo: !Command
    description: Test xargo is installed in container rustCrossDev
    container: rustCrossDev
    run: |
      which xargo
      # xargo --version
      
  testPkgConfig: !Command
    description: Test pkg-config is installed and will find openssl in container rustCrossDev2
    container: rustCrossDev2
    run: |
      which pkg-config
      pkg-config --libs --cflags openssl



  # Commands to help debug containters

  list: !Command
    description: List container's root directory, recursive
    container: rustCrossDev
    run: |
      ls -R /
  
  listTargets: !Command
    description: List targets precompiled by Rust
    container: rustCrossARMDev
    run: |
      rustc --print target-list

  # This doesn't seem to work, maybe xargo is not log enabled
  catRustLog: !Command
    description: invoke xargo to build sysroot with logging enabled
    container: rustCrossBareARMDev
    run: |
      RUST_LOG=xargo xargo --target foo

  listSysroot: !Command
    description: List sysroot i.e. system crates
    container: rustCrossBareARMDev
    run: |
      rustc --print sysroot



  # Not working???
  findXargo: !Command
    description: Find xargo
    container: rustCrossDev
    run: |
      "find / -name xargo"
      
    
      
  env: !Command
    description: List env of rustDev
    container: rustDev
    run: |
      env
      
  listDemo: !Command
    description: List demo directory of rustCortexM
    container: rustCortexM
    run: |
      ls -al /work/demo
     
     
        
  
    #- !Sh "ls -alR /tmp"
    #- !Sh "ls -R"
    
    # cargo installs to $CARGO_HOME/.cargo/bin but falls back to /tmp/.cargo/bin if CARGO_HOME is not defined???
    # cargo installs generated artifacts to $CARGO_TARGET_DIR but defaults to /tmp?
    # Here, define CARGO_HOME, because /tmp seems to get cleared
 